 from email wed jul number number number return-path email delivered-to email receiv from localhost (localhost number by phobos.labs.netnoteinc.com (postfix) with esmtp id number for email wed number jul number number number (edt) receiv from dogma.slashnull.org number by localhost with imap number for email (single-drop) wed number jul number number number (ist) receiv from listman.spamassassin.taint.org (listman.spamassassin.taint.org number by dogma.slashnull.org number with esmtp id number for email wed number jul number number number receiv from listman.spamassassin.taint.org (localhost.localdomain number by listman.redhat.com (postfix) with esmtp id number wed number jul number number number (edt) delivered-to email receiv from number number number by listman.redhat.com (postfix) with esmtp id number for email wed number jul number number number (edt) receiv (from email by number number id number for email wed number jul number number number receiv from number number number by number number with smtp id number for email wed number jul number number number receiv from tippex.localdomain number number by number number with smtp id number for email wed number jul number number number receiv by tippex.localdomain (postfix from userid number id number wed number jul number number number (cest) receiv from tippex.localdomain (localhost number by tippex.localdomain (postfix) with esmtp id number wed number jul number number number (cest) x-mailer exmh version number number with number to chris garrigu email email subject patch (was re anoth bug) in-reply-to messag from ander eriksson email of "tue number jul number number number email mime-vers number content-typ multipart/mix  number from ander eriksson email message-id email x-loop email sender email errors-to email x-beenther email x-mailman-vers number preced bulk list-help email list-post email list-subscrib URL email list-id discuss list for exmh develop  list-unsubscrib URL email list-arch URL date wed number jul number number number this is a multipart mime messag number content-typ text/plain charset=us-ascii email said  i just check in a code cleanup which doesn't address this issu  but doe take a machet to code right around it you ought to cvs  updat and see if your issu becom ani clearer with all the  brush remov  my patch note that msgid and line are redund with one  anoth and remov one or the other from function which take  both the caller are then chang to pass what the function  expect in the case of msg_chang the line argument is remov  and we onli have the msgid argument ftoc_clearcurr is now the  first line of msgchang the follow patch remov ftoc_rescanlin in favour of a ftoc_rescanlin it run number on a list of line and updat ftoc accord the patch also chang all the caller to make use of it it also chang ftoc_clearcurr to work of an argument instead of falsili clear a messag that still current on disk all in an effort to get a one-to-on disk-display correspond it doe add number -- ~ number ms percent to the execut time depend on folder size due to the invoc of scan howev this version doe not tri to second guess the mh version of scan so if you have exot scanlin it tell the truth as a side effect the + sign now correspond better to what on disk comment appreci i'm go to be offlik for a coupl of day so i send the cvs diff rather than put it in the cvs /ander number content-typ application/x-patch  name="exmh.patch" content-descript exmh.patch content-disposit attach filename="exmh.patch" index lib/ftoc.tcl =================================================================== rcs file /cvsroot/exmh/exmh/lib/ftoc.tcl,v retriev revis number diff -u -b -b -w -p number ftoc.tcl --- lib/ftoc.tcl number jul number number number number +++ lib/ftoc.tcl number jul number number number email number number email proc ftocpickrang { {addcurr number } { if dollar { ftoc_rangehighlight dollar dollar } - ftoc_clearcurr + ftoc_clearcurr dollar msg_clearcurr set ftoc(curline) {} } email number number email proc ftoc_newftoc {} { # ftoc_clearcurr and ftoc_chang are two part of # dink the ftoc display when advanc a messag -proc ftoc_clearcurr {} { - # clear display of current messag +# +# make line no longer appear as the current select line +# + +proc ftoc_clearcurr { line } { global ftoc exwin set ftoc(pickone) number set ftoc(lineset) {} - if dollar == {}} { - set ftoc(curline) [mh_cur dollar - } - if dollar != {}} { - dollar tag remov cur number dollar - ftoc_rescanlin dollar - } - return dollar -} -proc ftoc_chang { line {show show} } { +#we dont need this ani more sinc we work off the line +#argument not dollar +# if dollar == {}} { +# set ftoc(curline) [mh_cur dollar +# } +# if dollar != {}} { +# dollar tag remov cur number dollar +# ftoc_rescanlin dollar +# } + #should check that number line and error otherwis + dollar tag remov cur number dollar + ftoc_rescanlin [list dollar + +# return dollar +} + +# +# make newlin the current select line +# option clear oldlin from such attribut +# +proc ftoc_chang { newlin {oldlin {}}} { + global ftoc exwin - set ftoc(curline) dollar + + if {![info exist oldline]  dollar { + set oldlin {} + } + set ftoc(curline) dollar if dollar == {}} { set ok number } els { - if dollar == "show"} { dollar tag remov unseen number dollar + if dollar != {}} { + set ftoc(pickone) number + set ftoc(lineset) {} + dollar tag remov cur number dollar + ftoc_rescanlin [list dollar dollar + } els { + ftoc_rescanlin [list dollar } - ftoc_rescanlin dollar + dollar tag add cur number dollar set top dollar index email if [catch {expr number {set top number ;# trap number format icon email number number email proc ftoc_markseen { id } { } } } -proc ftoc_rescanlin { ix {plus none} } { +# +# this one is not use ani more kept here for refer +# +proc ftoc_rescanline_old { ix {plus none} } { global exmh exwin ftoc if [catch { set text dollar get number dollar email number number email proc ftoc_rescanlin { ix {plus none} } exmh_error "ftocrescanlin dollar  dollar } } + + +# +# rescan a set of line and updat the ftoc as need +# lines_in list of line number rang (e.g number are not allow +# +proc ftoc_rescanlin { lines_in } { + global exmh exwin ftoc mhprofil + + exmh_debug ftoc_rescanlin [ time { + #sort the line and weed out duplic + #they creep in when we chang folder + #set lastcandid {} + #foreach newcandid [lsort -integ dollar { + # if dollar != dollar { + # lappend line dollar + # exmh_debug "** dollar + # set lastcandid dollar + # } + #} + #never mind dupecheck the onli potenti is check for in + #ftoc_chang and the abov take time number ms) + set line [lsort -integ dollar + + foreach line dollar { + lappend msgnos [ftoc_msgnumb dollar + } + set input [open dollar \ + [list dollar \ + [join dollar \ + -width dollar + set text [split [string trim [read dollar \n ] \n ] + catch {close dollar + #exmh_debug "* dollar + + set ll [llength dollar + for {set i number dollar {incr i} { + set line [lindex dollar dollar + set tag dollar tag name number + dollar configur -state normal + dollar delet number dollar + dollar insert number [lindex dollar dollar + dollar configur -state disabl + foreach tag dollar { + dollar tag add dollar number dollar + } + } + } + ] +} + proc ftoc_nextimpli { {show show} {impli implied} } { global ftoc if dollar && dollar == "prev"} { email number number email proc ftoc_nextfold { {impli no} } { # if on last messag clear display becaus the # messag is move or delet if dollar != {}} { - ftoc_clearcurr + ftoc_clearcurr dollar msg_clearcurr } exmh_status "" email number number email proc ftoc_nextfold { {impli no} } { return } els { set ftoc(softchange) number - ftoc_clearcurr + ftoc_clearcurr dollar msg_clearcurr exmh_status "" exmh_status "end of folder   dollar warn email number number email proc ftoccommit {tagnam commitproc {cop set ftoc(displaydirty) number ftoc_clearmsgcach if dollar == dollar { - ftoc_clearcurr + ftoc_clearcurr dollar msg_clearcurr } if dollar == dollar { index lib/msg.tcl =================================================================== rcs file /cvsroot/exmh/exmh/lib/msg.tcl,v retriev revis number diff -u -b -b -w -p number msg.tcl --- lib/msg.tcl number jul number number number number +++ lib/msg.tcl number jul number number number email number number email proc msg_showunseen { {show show} } { return number } proc msg_clearcurr { } { - global msg exmh + global msg exmh ftoc + # are there case where this is not true + if dollar == dollar { + set prevlin [ftoc_findmsg [mh_cur dollar + if dollar == {}} { + unset prevlin + } + } set msg(id) {} ;# clear current messag set msg(dpy) {} ;# and current display messag mh_clearcur dollar + if {[info exist prevline]} { + ftoc_clearcurr dollar + } msgclear buttons_curr number uri_clearcurr email number number email proc msg_chang {msgid {show show} } { exmh_debug msg_chang [time [list msgchang dollar dollar } proc msgchang {msgid {show show}} { - global exmh exwin msg mhprofil + global exmh exwin msg mhprofil ftoc - ftoc_clearcurr + set prevlin [ftoc_findmsg [mh_cur dollar mh_setcur dollar dollar ftoc_showsequ dollar set line [ftoc_findmsg dollar - if { [ftoc_chang dollar dollar { + if { [ftoc_chang dollar dollar { exmh_status "cannot find msg dollar - rescan?" } els { if dollar == {}} { email number number email proc msg_uudecod {} { } proc msg_markunseen {} { - global exmh + global exmh ftoc msg_checkpoint ftoc_iter line { set msgid [ftoc_msgnumb dollar mh_markunseen dollar dollar } - msg_clearcurr - ftoc_clearcurr + ftoc_rescanlin dollar + #whi was this need + #msg_clearcurr + #not need anymor + #ftoc_clearcurr flist_forgetunseen dollar ftoc_showsequ dollar } index lib/scan.tcl =================================================================== rcs file /cvsroot/exmh/exmh/lib/scan.tcl,v retriev revis number diff -u -b -b -w -p number scan.tcl --- lib/scan.tcl number jul number number number number +++ lib/scan.tcl number jul number number number email number number email proc scan_cacheupd {} { # this thing # if dollar { - set curlin [ftoc_clearcurrent] ;# clear + + ftoc_clearcurr dollar ;# clear + if [file writabl dollar { set scancmd "exec dollar [list dollar \ -width dollar  [list dollar email number number email proc scan_cacheupd {} { exmh_status "fail to rescan folder dollar dollar warn } } - ftoc_chang dollar ;# restor it + ftoc_chang dollar ;# restor it } elseif [catch { set cacheio [open dollar w] - set curlin [ftoc_clearcurrent] ;# clear + + ftoc_clearcurr dollar ;# clear + set display dollar get number "end number char"] - ftoc_chang dollar ;# restor it + ftoc_chang dollar ;# restor it put dollar dollar nonewlin close dollar set ftoc(displaydirty) number number _______________________________________________ exmh-work mail list email URL